from typing import Dict, List, Any


FACT_SCHEMA_EXAMPLE = {
    "facts": [
        {
            "statement": "Краткое, самодостаточное утверждение (не более ~60 слов).",
            "sources": [
                {
                    "source_id": "msg:123",
                    "quote": "Короткая дословная цитата (опционально, до ~200 символов)."
                }
            ],
            "category": "Опциональная короткая категория/тэг (свободный текст)."
        }
    ]
}


def system_instructions() -> str:
    # Универсальная (домен-независимая) инструкция
    return (
        "Ты — универсальный экстрактор знаний. Твоя задача — извлекать из предоставленных фрагментов текста "
        "краткие, проверяемые, доменно-нейтральные факты и возвращать их строго в формате JSON по схеме ниже.\n\n"
        "Требования:\n"
        "- Работай в любой тематике (наука, техника, кулинария, законы и т.п.). Не привязывайся к конкретному домену.\n"
        "- Извлекай только факты, непосредственно подтверждённые текстом. Никаких домыслов или новых знаний.\n"
        "- Каждый факт — самодостаточное короткое утверждение (до ~60 слов), понятное без контекста.\n"
        "- Приоритет: извлекай определения и разъяснения сущностей/продуктов/систем (\"X — это ...\"), "
        "их назначение, аналоги/сравнения (\"Аналог ...\"), способы взаимодействия/режимы работы (через интерфейс, через API/скрипты, через пакетные менеджеры), "
        "ограничения/условия/допущения.\n"
        "- Факты могут быть извлечены из диалогов (вопрос-ответ) и копипасты — переформулируй в декларативное утверждение.\n"
        "- Для каждого факта укажи минимум один источник в виде объекта {source_id, quote?}:\n"
        "  - source_id строго вида 'msg:<число>'\n"
        "  - quote — опциональная короткая дословная цитата (до ~200 символов), подтверждающая факт.\n"
        "- Категория (category) — опциональна и может быть любым коротким тэгом для группировки.\n"
        "- Если фактов нет, верни {\"facts\": []}.\n"
        "- Вывод ДОЛЖЕН быть строго корректным JSON одним объектом без пояснений, комментариев и лишнего текста.\n\n"
        "JSON-схема результата (пример структуры):\n"
        f"{FACT_SCHEMA_EXAMPLE}"
    )


def _format_sources_block(sources: List[Dict[str, Any]]) -> str:
    # Формируем унифицированный блок источников для user-сообщения
    lines: List[str] = []
    for item in sources:
        sid = item.get("source_id", "")
        text = item.get("text", "")
        # Разделяем источники визуально, сохраняя чистый текст
        lines.append(f"--- {sid} ---")
        lines.append(text)
        lines.append("")  # пустая строка-разделитель
    return "\n".join(lines).strip()


def build_messages(sources: List[Dict[str, Any]], hints: str = "") -> List[Dict[str, str]]:
    """
    Формирует сообщения для чат-модели.
    sources: список элементов вида {"source_id": "msg:123", "text": "..."}
    hints: опциональные дополнительные подсказки (доменно-нейтральные).
    """
    sys = system_instructions()
    if hints:
        sys += "\n\nДополнительные подсказки (доменно-нейтральные):\n" + hints.strip()

    user_content = (
        "Ниже приведён набор источников вида 'msg:<id>' и их тексты. "
        "Извлеки из них максимально полезные и проверяемые факты, соблюдая правила и вернув КОРРЕКТНЫЙ JSON."
        "\n\n"
        + _format_sources_block(sources)
        + "\n\nВерни только JSON-объект без пояснений."
    )

    return [
        {"role": "system", "content": sys},
        {"role": "user", "content": user_content},
    ]


def build_repair_messages(bad_output: str) -> List[Dict[str, str]]:
    """
    Сообщения для «ремонта» ответа: преобразовать произвольный/некорректный вывод в валидный JSON заданной схемы.
    """
    sys = (
        "Ты — помощник-валидатор. Твоя задача — ПРЕОБРАЗОВАТЬ предложенный вывод в строго валидный JSON по заданной схеме.\n"
        "- Сохрани как можно ближе исходные факты, если они уже есть.\n"
        "- Исправь только структуру/формат, не придумывая новые факты.\n"
        "- Если фактов нет, верни {\"facts\": []}.\n"
        "- Итог — чистый JSON-объект без комментариев и текста вокруг."
    )
    user = (
        "Преобразуй следующее содержимое в валидный JSON по схеме FACT_SCHEMA_EXAMPLE:\n\n"
        "----- НАЧАЛО -----\n"
        f"{bad_output}\n"
        "----- КОНЕЦ -----\n\n"
        f"Схема/пример структуры:\n{FACT_SCHEMA_EXAMPLE}\n\n"
        "Верни только JSON-объект."
    )
    return [
        {"role": "system", "content": sys},
        {"role": "user", "content": user},
    ]
